name: Manual Service Restart

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to manage'
        required: true
        default: restart
        type: choice
        options:
          - start
          - stop
          - restart
      reason:
        description: 'Reason for action'
        required: true
        default: 'Manual trigger via GitHub Actions'

jobs:
  manage-gunicorn:
    runs-on: ubuntu-latest
    steps:
      - name: Manage Gunicorn Service
        run: |
          echo "üîß Action: ${{ github.event.inputs.service }} - Reason: ${{ github.event.inputs.reason }}"

          gcloud compute ssh "$VM_NAME" --zone "$ZONE" --project "$PROJECT_ID" --command="
            case '${{ github.event.inputs.service }}' in
              start)
                sudo systemctl start gunicorn
                ;;
              stop)
                sudo systemctl stop gunicorn
                ;;
              restart)
                sudo systemctl restart gunicorn
                ;;
              *)
                echo '‚ùå Unknown action: ${{ github.event.inputs.service }}'
                exit 1
                ;;
            esac

            sleep 3
            if sudo systemctl is-active --quiet gunicorn; then
              echo '‚úÖ Gunicorn is running'
            else
              echo '‚ùå Gunicorn is not running'
            fi

            sudo systemctl status gunicorn --no-pager -l
          "
