name: Manual Service Restart

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to manage'
        required: true
        default: restart
        type: choice
        options:
          - start
          - stop
          - restart
      reason:
        description: 'Reason for action'
        required: true
        default: 'Manual trigger via GitHub Actions'

env:
  PROJECT_ID: dynamic-now-438707-c1
  ZONE: asia-south1-b
  VM_NAME: hello-test-feature  # replace with your VM name

jobs:
  manage-gunicorn:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          token_format: 'access_token'
          workload_identity_provider: 'projects/568722140219/locations/global/workloadIdentityPools/github-pool/providers/github'
          service_account: 'github-actions@dynamic-now-438707-c1.iam.gserviceaccount.com'

      - name: Manage Gunicorn Service
        run: |
          echo "üîß Action: ${{ github.event.inputs.service }} - Reason: ${{ github.event.inputs.reason }}"

          gcloud compute ssh "$VM_NAME" --zone "$ZONE" --project "$PROJECT_ID" --command="
            case '${{ github.event.inputs.service }}' in
              start)
                sudo systemctl start gunicorn
                ;;
              stop)
                sudo systemctl stop gunicorn
                ;;
              restart)
                sudo systemctl restart gunicorn
                ;;
              *)
                echo '‚ùå Unknown action: ${{ github.event.inputs.service }}'
                exit 1
                ;;
            esac

            sleep 3
            if sudo systemctl is-active --quiet gunicorn; then
              echo '‚úÖ Gunicorn is running'
            else
              echo '‚ùå Gunicorn is not running'
            fi

            sudo systemctl status gunicorn --no-pager -l
          "
